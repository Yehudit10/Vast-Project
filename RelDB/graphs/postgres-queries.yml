# Save as postgres-queries.yml
# Custom queries for postgres_exporter to expose WAL, replication lag, and BRIN stats.

pg_wal_stats:
  query: |
    SELECT wal_records, wal_fpi, wal_bytes
    FROM pg_stat_wal
  metrics:
    - wal_records:
        usage: COUNTER
        description: "Number of WAL records since startup"
    - wal_fpi:
        usage: COUNTER
        description: "Number of WAL full page images since startup"
    - wal_bytes:
        usage: COUNTER
        description: "Total WAL bytes generated since startup"

# On PRIMARY: lag in bytes per replica
pg_replication_lag_bytes_primary:
  query: |
    SELECT
      application_name,
      GREATEST(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn), 0) AS bytes_lag
    FROM pg_stat_replication
  metrics:
    - application_name:
        usage: LABEL
        description: "Replica application_name as seen from primary"
    - bytes_lag:
        usage: GAUGE
        description: "Replication lag in bytes (primary view)"

# On STANDBY: lag in seconds (returns a row only on standby)
pg_replication_replay_lag_seconds_standby:
  query: |
    SELECT
      EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) AS replay_lag_seconds
    WHERE pg_is_in_recovery()
  metrics:
    - replay_lag_seconds:
        usage: GAUGE
        description: "Replication replay lag in seconds (standby only)"

# BRIN index I/O and hit ratio per BRIN index
pg_brin_index_io:
  query: |
    SELECT
      s.schemaname,
      s.relname AS table_name,
      s.indexrelname AS index_name,
      s.idx_blks_read,
      s.idx_blks_hit,
      CASE
        WHEN (s.idx_blks_read + s.idx_blks_hit) > 0
          THEN (s.idx_blks_hit::float / (s.idx_blks_read + s.idx_blks_hit))
        ELSE NULL
      END AS brin_hit_ratio
    FROM pg_statio_user_indexes s
    JOIN pg_class i ON i.oid = s.indexrelid
    JOIN pg_am am ON am.oid = i.relam
    WHERE am.amname = 'brin'
  metrics:
    - schemaname:
        usage: LABEL
        description: "Schema"
    - table_name:
        usage: LABEL
        description: "Table"
    - index_name:
        usage: LABEL
        description: "BRIN index name"
    - idx_blks_read:
        usage: COUNTER
        description: "Index blocks read from disk for this BRIN index"
    - idx_blks_hit:
        usage: COUNTER
        description: "Index blocks found in cache for this BRIN index"
    - brin_hit_ratio:
        usage: GAUGE
        description: "Cache hit ratio for this BRIN index (0..1)"


# Active connections
pg_active_connections:
  query: |
    SELECT state, COUNT(*) as count
    FROM pg_stat_activity
    GROUP BY state
  metrics:
    - state:
        usage: LABEL
        description: "Connection state (active, idle, etc.)"
    - count:
        usage: GAUGE
        description: "Number of connections per state"

# Cache hit ratio per table
pg_table_cache_hit_ratio:
  query: |
    SELECT
      relname as table,
      heap_blks_read,
      heap_blks_hit,
      CASE
        WHEN (heap_blks_read + heap_blks_hit) > 0
        THEN (heap_blks_hit::float / (heap_blks_read + heap_blks_hit))
        ELSE NULL
      END as cache_hit_ratio
    FROM pg_statio_user_tables
  metrics:
    - table:
        usage: LABEL
        description: "Table name"
    - heap_blks_read:
        usage: COUNTER
        description: "Disk blocks read"
    - heap_blks_hit:
        usage: COUNTER
        description: "Cache hits"
    - cache_hit_ratio:
        usage: GAUGE
        description: "Cache hit ratio (0..1)"

# Database size
pg_database_size:
  query: |
    SELECT datname, pg_database_size(datname) as size_bytes
    FROM pg_database
  metrics:
    - datname:
        usage: LABEL
        description: "Database name"
    - size_bytes:
        usage: GAUGE
        description: "Database size in bytes"

# ============================================
# LEAF DISEASES METRICS
# ============================================

# Total leaf reports
leaf_reports_total:
  query: "SELECT COUNT(*)::float as total FROM public.leaf_reports"
  master: true
  metrics:
    - total:
        usage: "GAUGE"
        description: "Total number of leaf disease reports"

# Reports by disease type
leaf_reports_by_disease:
  query: |
    SELECT 
      COALESCE(ldt.name, 'Unknown') as disease_name,
      lr.leaf_disease_type_id::text as disease_id,
      COUNT(*)::float as count 
    FROM public.leaf_reports lr
    LEFT JOIN public.leaf_disease_types ldt ON lr.leaf_disease_type_id = ldt.id
    WHERE lr.sick = true
    GROUP BY lr.leaf_disease_type_id, ldt.name
  master: true
  metrics:
    - disease_name:
        usage: "LABEL"
        description: "Disease name"
    - disease_id:
        usage: "LABEL"
        description: "Disease type ID"
    - count:
        usage: "GAUGE"
        description: "Number of reports per disease"

# Reports by device
leaf_reports_by_device:
  query: |
    SELECT 
      device_id::text as device_id,
      COUNT(*)::float as total_reports,
      SUM(CASE WHEN sick THEN 1 ELSE 0 END)::float as sick_reports
    FROM public.leaf_reports
    GROUP BY device_id
  master: true
  metrics:
    - device_id:
        usage: "LABEL"
        description: "Device ID"
    - total_reports:
        usage: "GAUGE"
        description: "Total reports per device"
    - sick_reports:
        usage: "GAUGE"
        description: "Sick reports per device"

# Daily disease progression (time series)
leaf_disease_daily_progression:
  query: |
    SELECT 
      COALESCE(ldt.name, 'Unknown') as disease_name,
      lr.leaf_disease_type_id::text as disease_id,
      TO_CHAR(DATE_TRUNC('day', lr.ts), 'YYYY-MM-DD') as report_date,
      EXTRACT(EPOCH FROM DATE_TRUNC('day', lr.ts))::float as date_timestamp,
      COUNT(*)::float as sick_count
    FROM public.leaf_reports lr
    LEFT JOIN public.leaf_disease_types ldt ON lr.leaf_disease_type_id = ldt.id
    WHERE lr.sick = true
      AND lr.ts > NOW() - INTERVAL '90 days'
    GROUP BY lr.leaf_disease_type_id, ldt.name, DATE_TRUNC('day', lr.ts)
    ORDER BY date_timestamp DESC
  master: true
  metrics:
    - disease_name:
        usage: "LABEL"
        description: "Disease name"
    - disease_id:
        usage: "LABEL"
        description: "Disease type ID"
    - report_date:
        usage: "LABEL"
        description: "Report date (YYYY-MM-DD)"
    - date_timestamp:
        usage: "GAUGE"
        description: "Date timestamp for X axis"
    - sick_count:
        usage: "GAUGE"
        description: "Number of sick reports per day"

# Hourly disease detection (last 7 days)
leaf_disease_hourly_detection:
  query: |
    SELECT 
      COALESCE(ldt.name, 'Unknown') as disease_name,
      lr.leaf_disease_type_id::text as disease_id,
      EXTRACT(EPOCH FROM DATE_TRUNC('hour', lr.ts))::float as hour_timestamp,
      COUNT(*)::float as count
    FROM public.leaf_reports lr
    LEFT JOIN public.leaf_disease_types ldt ON lr.leaf_disease_type_id = ldt.id
    WHERE lr.sick = true
      AND lr.ts > NOW() - INTERVAL '7 days'
    GROUP BY lr.leaf_disease_type_id, ldt.name, DATE_TRUNC('hour', lr.ts)
    ORDER BY hour_timestamp DESC
  master: true
  metrics:
    - disease_name:
        usage: "LABEL"
        description: "Disease name"
    - disease_id:
        usage: "LABEL"
        description: "Disease type ID"
    - hour_timestamp:
        usage: "GAUGE"
        description: "Hour timestamp"
    - count:
        usage: "GAUGE"
        description: "Detections per hour"

# Disease severity by device (percentage)
leaf_disease_severity_by_device:
  query: |
    SELECT 
      COALESCE(ldt.name, 'Unknown') as disease_name,
      lr.leaf_disease_type_id::text as disease_id,
      lr.device_id::text as device_id,
      (SUM(CASE WHEN lr.sick THEN 1 ELSE 0 END)::float / COUNT(*)::float * 100) as sick_percentage
    FROM public.leaf_reports lr
    LEFT JOIN public.leaf_disease_types ldt ON lr.leaf_disease_type_id = ldt.id
    WHERE lr.ts > NOW() - INTERVAL '30 days'
    GROUP BY lr.leaf_disease_type_id, ldt.name, lr.device_id
    HAVING COUNT(*) > 5
  master: true
  metrics:
    - disease_name:
        usage: "LABEL"
        description: "Disease name"
    - disease_id:
        usage: "LABEL"
        description: "Disease type ID"
    - device_id:
        usage: "LABEL"
        description: "Device ID"
    - sick_percentage:
        usage: "GAUGE"
        description: "Percentage of sick reports (0-100)"
