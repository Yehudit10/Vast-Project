version: "3.9"

services:
  kafka:
    image: bitnami/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    env_file:
      - ./.env.kafka
    healthcheck:
      test: ["CMD", "bash", "-lc", "/opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 30
    # Option: persist local data (not required for POC)
    # volumes:
    #   - ./data:/bitnami/kafka


  topics-init:
    image: bitnami/kafka:latest
    container_name: kafka-topics-init
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      BOOTSTRAP: "kafka:9092"
      RETENTION_DAYS: "7"
    volumes:
      - ./create-topics.sh:/work/create-topics.sh:ro
    entrypoint: [ "bash", "-lc" ]
    command: >
      'tr -d "\r" </work/create-topics.sh >/tmp/create-topics.sh &&
       chmod +x /tmp/create-topics.sh &&
       /tmp/create-topics.sh'


# services:
#   kafka:
#     image: bitnami/kafka:3.7
#     container_name: kafka
#     ports:
#       - "9092:9092"
#     environment:
#       # --- Run Kafka in KRaft mode (no ZooKeeper) ---
#       - KAFKA_ENABLE_KRAFT=yes
#       - KAFKA_CFG_NODE_ID=1
#       - KAFKA_CFG_PROCESS_ROLES=broker,controller
#       - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
#       - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
#       - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
#       - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
#       - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
#       - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT

#       # --- Config values equivalent to your values-kafka.yaml ---
#       - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=false
#       - ALLOW_PLAINTEXT_LISTENER=yes
#       - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=1
#       - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
#       - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=1

#     volumes:
#       - kafka_data:/bitnami/kafka

#     healthcheck:
#       # Simple healthcheck: list topics to ensure broker is alive
#       test: [ "CMD-SHELL", "/opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1" ]
#       interval: 10s
#       timeout: 5s
#       retries: 12
#       start_period: 10s

#   topics-init:
#     image: bitnami/kafka:3.7
#     depends_on:
#       kafka:
#         condition: service_healthy
#     environment:
#       # Your script reads BOOTSTRAP; inside this container the broker is "kafka:9092"
#       BOOTSTRAP: kafka:9092
#       RETENTION_DAYS: "7"
#     volumes:
#       - ./create-topics.sh:/init/create-topics.sh:ro
#     entrypoint: [ "bash", "-lc", "/init/create-topics.sh" ]
#     restart: "no"

# volumes:
#   kafka_data:
