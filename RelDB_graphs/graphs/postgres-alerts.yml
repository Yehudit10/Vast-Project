groups:
  - name: postgres_alerts
    interval: 30s

    rules:
      # 1) קצב WAL גבוה מאוד (תנועה חריגה)
      - alert: HighWalThroughput
        expr: pg:wal_bytes:rate_per_s > 5e6   # > ~5MB/s ל-5 דקות
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High WAL throughput"
          description: "WAL rate {{ $value | humanize }} B/s מעל הסף במשך 5 דקות"

      # 2) אין כמעט WAL (סיכון: מערכת 'קפאה' או אין תנועה)
      - alert: LowWalThroughput
        expr: pg:wal_bytes:rate_per_s < 1000  # < 1KB/s
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Very low WAL throughput"
          description: "כמעט ואין כתיבות ל-WAL במשך 10 דקות"

      # 3) דיליי רפליקציה (אם יש רפליקות)
      - alert: ReplicationLagSecondsHigh
        expr: pg:replication_lag_seconds > 120
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Replication lag high (seconds)"
          description: "Lag שניות גבוה מ-120 במשך 5 דקות"

      - alert: ReplicationLagBytesHigh
        expr: pg:replication_lag_bytes > 50e6  # > ~50MB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Replication lag high (bytes)"
          description: "Lag בבייטים גבוה מ-50MB במשך 5 דקות"

      # 4) יעילות BRIN נמוכה
      - alert: BrinHitRatioLow
        expr: pg:brin_hit_ratio < 0.6
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "BRIN hit ratio low"
          description: "יחס פגיעות BRIN ירד מתחת ל-60% במשך 10 דקות"

      # 5) ה-exporter נפל
      - alert: PostgresExporterDown
        expr: up{job="postgres_exporter"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "postgres_exporter down"
          description: "ה-exporter אינו זמין במשך 2 דקות"
