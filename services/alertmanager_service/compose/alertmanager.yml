
global:
  resolve_timeout: 24h

route:
  receiver: "null"
  group_by: ["alertname", "device", "alert_id"]
  group_wait: 0s
  group_interval: 1s
  repeat_interval: 2h
  routes:
    # 1ï¸âƒ£ Gateway route
    - receiver: "gateway"
      continue: true
      matchers:
        - source="agcloud-alerts"

    # 2ï¸âƒ£ Slack route
    - receiver: "slack"
      continue: false
      matchers:
        - source="agcloud-alerts"

receivers:
  - name: "null"

  - name: "gateway"
    webhook_configs:
      - url: "http://alerts-gateway:8000/internal/alert"
        send_resolved: true

  - name: "slack"
    slack_configs:
      - api_url_file: /run/secrets/slack_webhook
        channel: "all-agcloud"         # FIXED (no "#")
        send_resolved: true
        username: "AgCloud Alerts"
        icon_emoji: ":rotating_light:"

        title: >-
          {{ if eq .Status "resolved" }}
            âšª EVENT CLOSED: {{ .CommonLabels.alertname }} on {{ .CommonLabels.device }}
          {{ else }}
            ðŸ”´ ACTIVE ALERT: {{ .CommonLabels.alertname }} on {{ .CommonLabels.device }}
          {{ end }}

        text: |-
          {{ if eq .Status "resolved" }}
          *Event closed.*

          *Type:* {{ .CommonLabels.alertname }}
          *Device:* {{ .CommonLabels.device }}
          *Alert ID:* {{ .CommonLabels.alert_id }}

          *Duration:* {{ (index .Alerts 0).StartsAt }} â†’ {{ (index .Alerts 0).EndsAt }}

          *Summary:* {{ .CommonAnnotations.summary }}

          _No further activity detected. The alert has been automatically closed._

          {{ else }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Recommendation:* {{ .CommonAnnotations.recommendation }}
          *Severity:* {{ .CommonAnnotations.severity }}
          *Category:* {{ .CommonAnnotations.category }}

          {{- if .CommonAnnotations.image_url }}
          <{{ .CommonAnnotations.image_url }}|ðŸ“· Image>
          {{- end }}

          {{- if .CommonAnnotations.vod }}
          | <{{ .CommonAnnotations.vod }}|ðŸŽžï¸ VOD>
          {{- end }}

          {{- if .CommonAnnotations.hls }}
          | <{{ .CommonAnnotations.hls }}|ðŸ“º HLS>
          {{- end }}

          _ðŸ•’ ID: {{ .CommonLabels.alert_id }}_
          {{ end }}

