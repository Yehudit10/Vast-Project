apiVersion: batch/v1
kind: CronJob
metadata:
  name: ripeness-rollup
  namespace: vectordb
spec:
  schedule: "0 3 * * 1"          
  timeZone: "Asia/Jerusalem"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: ripeness
            image: ripeness-baseline:local
            imagePullPolicy: Never
            env:
            - name: PGHOST
              value: "192.168.1.124"  
            - name: PGPORT
              value: "5432"
            - name: PGDATABASE
              value: "missions_db"
            - name: PGUSER
              value: "missions_user"
            - name: PGPASSWORD
              value: "Missions!ChangeMe123"
            - name: PGSSLMODE
              value: "disable"

            - name: MINIO_URL
              value: "http://REPLACE_WITH_WINDOWS_IP:9001"
            - name: MINIO_BUCKET
              value: "imagery"
            - name: MINIO_ACCESS_KEY
              value: "minioadmin"
            - name: MINIO_SECRET_KEY
              value: "minioadmin123"

            - name: FRUIT_LIST
              value: "apple,banana,pear"
            - name: DEFAULT_PREFIX
              value: "test"  

            command: ["/bin/sh","-lc"]
            args:
              - |
                set -eu
                fruits=$(printf "%s" "$FRUIT_LIST" | tr ',' ' ')
                for f in $fruits; do
                  export FRUIT_TYPE="$f"
                  if [ -n "${DEFAULT_PREFIX:-}" ]; then
                    export MINIO_PREFIX="${f}/${DEFAULT_PREFIX}"
                  else
                    export MINIO_PREFIX="${f}/test"
                  fi
                  echo "=== Running $FRUIT_TYPE (prefix=$MINIO_PREFIX) ==="
                  python -u /app/src/main.py
                done

