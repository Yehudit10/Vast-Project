apiVersion: v1
kind: Namespace
metadata:
  name: vectordb
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pg-init
  namespace: vectordb
data:
  01_schema.sql: |
    CREATE EXTENSION IF NOT EXISTS vector;

    CREATE TABLE IF NOT EXISTS embeddings (
      id BIGSERIAL PRIMARY KEY,
      vec vector(384)
    );

    -- בונים את אינדקס HNSW כפי שנדרש (m=4, ef_construction=10)
    CREATE INDEX IF NOT EXISTS idx_embeddings_vec_hnsw
      ON embeddings USING hnsw (vec vector_l2_ops)
      WITH (m=4, ef_construction=10);

    -- טבלת מדידות לבנצ'מרק
    CREATE TABLE IF NOT EXISTS nn42_bench(
      ts timestamptz DEFAULT now(),
      ms double precision
    );

    -- פונקציית בנצ'מרק יחיד
    CREATE OR REPLACE FUNCTION bench_nn42_once() RETURNS double precision AS $$
    DECLARE
      q vector(384);
      t0 timestamptz;
      dur_ms double precision;
    BEGIN
      SELECT ARRAY(SELECT random() FROM generate_series(1,384))::vector(384) INTO q;
      t0 := clock_timestamp();
      PERFORM id FROM embeddings ORDER BY vec <-> q LIMIT 42;
      dur_ms := EXTRACT(EPOCH FROM (clock_timestamp() - t0)) * 1000.0;
      INSERT INTO nn42_bench(ms) VALUES (dur_ms);
      RETURN dur_ms;
    END$$ LANGUAGE plpgsql;
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pg-exp-queries
  namespace: vectordb
data:
  queries.yaml: |
    pgvector_nn42:
      query: |
        SELECT '5m'::text AS window,
               COALESCE(AVG(ms),0) AS avg_ms
        FROM nn42_bench
        WHERE ts > now() - interval '5 minutes';
      metrics:
        - window:
            usage: "LABEL"
        - avg_ms:
            usage: "GAUGE"
            description: "Avg 42-NN latency over last 5m (ms)"
---
apiVersion: v1
kind: Service
metadata:
  name: pg
  namespace: vectordb
spec:
  selector:
    app: pg
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432
    - name: metrics
      port: 9187
      targetPort: 9187
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: pg
  namespace: vectordb
spec:
  serviceName: pg
  replicas: 1
  selector:
    matchLabels:
      app: pg
  template:
    metadata:
      labels:
        app: pg
    spec:
      containers:
        - name: postgres
          image: pgvector/pgvector:pg16
          imagePullPolicy: IfNotPresent
          env:
            - name: POSTGRES_USER
              value: postgres
            - name: POSTGRES_PASSWORD
              value: postgres
            - name: POSTGRES_DB
              value: vectordb
          ports:
            - name: postgres
              containerPort: 5432
          volumeMounts:
            - name: pgdata
              mountPath: /var/lib/postgresql/data
            - name: init-sql
              mountPath: /docker-entrypoint-initdb.d
        - name: exporter
          image: quay.io/prometheuscommunity/postgres-exporter:v0.15.0
          imagePullPolicy: IfNotPresent
          args:
            - --extend.query-path=/etc/postgres_exporter/queries.yaml
          env:
            - name: DATA_SOURCE_URI
              value: "localhost:5432/vectordb?sslmode=disable"
            - name: DATA_SOURCE_USER
              value: "postgres"
            - name: DATA_SOURCE_PASS
              value: "postgres"
            - name: PG_EXPORTER_EXTEND_QUERY_PATH
              value: /etc/postgres_exporter/queries.yaml
          ports:
            - name: metrics
              containerPort: 9187
          volumeMounts:
            - name: exp-queries
              mountPath: /etc/postgres_exporter
      volumes:
        - name: init-sql
          configMap:
            name: pg-init
        - name: exp-queries
          configMap:
            name: pg-exp-queries
  volumeClaimTemplates:
    - metadata:
        name: pgdata
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 5Gi
---
# CronJob שמייצר דגימות ל-nn42_bench כל דקה (כדי שתהיה סדרת זמן לגרף)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: nn42-bench
  namespace: vectordb
spec:
  schedule: "*/1 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: runner
              image: docker.io/bitnami/postgresql:17.6.0-debian-12-r0
              env:
                - name: PGPASSWORD
                  value: "postgres"
              command: ["psql","-h","pg","-U","postgres","-d","vectordb","-c","SELECT bench_nn42_once();"]
